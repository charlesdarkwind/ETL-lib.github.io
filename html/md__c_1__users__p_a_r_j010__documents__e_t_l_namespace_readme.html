<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ETL Library: readme</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ETL Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">readme </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Documentation: <a href="https://charlesdarkwind.github.io/ETL-lib.github.io/html/">https://charlesdarkwind.github.io/ETL-lib.github.io/html/</a></p>
<p>For development or analysis purposes, the library saves time by never mounting volumes unless necessary or if asked to mount anyway, even after clearing a notebook's state.  The volumes accessibility is always assessed at the last possible moment to reduce the chances of using outdated credentials.</p>
<p>Tables data location is abstracted away.</p>
<hr  />
 <p>&#160;</p>
<p><a class="anchor" id="autotoc_md0"></a></p><h5>Standard / low abstraction modules</h5>
<ul>
<li>raw</li>
<li>curated</li>
<li>trusted</li>
<li>raw_control</li>
<li>curated_control</li>
</ul>
<p>These modules contain utility functions for read, write and delete operations while enforcing conventional naming, file and folder locations and other standards to keep things organised.</p>
<p>These also log a lot of debug informations in a log file located at:</p><ul>
<li>windows: C://logs</li>
<li>data lake: raw-zone/logs</li>
</ul>
<hr  />
 <p>&#160;</p>
<p><a class="anchor" id="autotoc_md1"></a></p><h5>Utility modules</h5>
<ul>
<li>utils</li>
<li>config</li>
<li>dbfs_utils</li>
<li>json_utils</li>
<li>delta_utils</li>
</ul>
<p>For more flexibility in order to build pipelines that can cover many other use cases. The higher-order / standard modules seen before all implement functions from these utility modules.</p>
<p><b>utils</b> is the only module that can be imported, and its functions used, from anywhere without needing spark or a databricks connection.</p>
<hr  />
 <p>&#160;</p>
<h4><a class="anchor" id="autotoc_md2"></a>
Installation</h4>
<div class="fragment"><div class="line">pip install ETL-lib</div>
</div><!-- fragment --><div class="fragment"><div class="line">dbutils.library.installPyPI(&#39;ETL-lib&#39;)</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md3"></a>
Examples</h4>
<div class="fragment"><div class="line">from pyspark.sql.functions import to_timestamp, col</div>
<div class="line">from pyspark.sql.types import TimestampType</div>
<div class="line"> </div>
<div class="line">from yammer_params import params</div>
<div class="line">from ETL import *</div>
<div class="line"> </div>
<div class="line">config = Config(params)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">def parse_date(df):</div>
<div class="line">  return df.withColumn(</div>
<div class="line">    &#39;created_at&#39;, to_timestamp(col(&#39;created_at&#39;).cast(TimestampType()), &quot;yyyy-mm-dd&#39;T&#39;HH:mm:ss&quot;))</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"># Read all raw-zone data for table &quot;Messages&quot; and overwrite the curated-zone delta table:</div>
<div class="line">curated.write(config, &#39;Messages&#39;, transformation=parse_date)</div>
<div class="line"> </div>
<div class="line"># Read only new raw-zone folders and merge it into the curated-zone:</div>
<div class="line">curated.merge(config, &#39;Messages&#39;, transformation=parse_date, incremental=True)</div>
<div class="line"> </div>
<div class="line"># Since raw can only go to curated, ETL.curated_tables.merge() and ETL.curated.write() do it implicitly</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"># Example of the same merge but more explicitly using other functions from the library</div>
<div class="line">def raw_to_curated(table, transformation=None, incremental=True):</div>
<div class="line"> </div>
<div class="line">  # Read raw data, also retrieve potential control table updates</div>
<div class="line">  df, short_paths = raw.read(config, table, incremental=incremental)</div>
<div class="line"> </div>
<div class="line">  # Clean it</div>
<div class="line">  if transformation and not utils.df_empty(df):</div>
<div class="line">    df = transformation(df)</div>
<div class="line"> </div>
<div class="line">  # Merge into curated table</div>
<div class="line">  curated.merge(config, table, df, incremental=incremental)</div>
<div class="line"> </div>
<div class="line">  # Update control table</div>
<div class="line">  raw_control.insert(config, short_paths)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">&quot;&quot;&quot;</div>
<div class="line">&gt;&gt;&gt; help(ETL.curated.write)</div>
<div class="line"> </div>
<div class="line">write(config, table, df=None, transformation=None, incremental=False, **dataframe_writer_options)</div>
<div class="line">    Write/save data in the delta table(s).</div>
<div class="line">    </div>
<div class="line">    Parameters</div>
<div class="line">    ----------</div>
<div class="line">    config: Config</div>
<div class="line">      Config instance</div>
<div class="line">    </div>
<div class="line">    table: str</div>
<div class="line">      Name of the table / folder.</div>
<div class="line">    </div>
<div class="line">    df: pyspark.sql.DataFrame, optional</div>
<div class="line">      Dataframe containing the data to save in the curated delta table.</div>
<div class="line">    </div>
<div class="line">    transformation: (pyspark.sql.DataFrame) -&gt; pyspark.sql.DataFrame, optional</div>
<div class="line">      A function taking a df and returning a df.</div>
<div class="line">    </div>
<div class="line">    incremental: bool, optional</div>
<div class="line">      To perform incremental load based on the raw-zone&#39;s control table content.</div>
<div class="line">    </div>
<div class="line">    dataframe_writer_options:</div>
<div class="line">        mode: str</div>
<div class="line">            &#39;overwrite&#39; or &#39;append&#39;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">&gt;&gt;&gt; help(ETL.curated.merge)</div>
<div class="line"> </div>
<div class="line">merge(config, table, df=None, transformation=None, unique_key=None, incremental=False)</div>
<div class="line">    Update data in the delta table.</div>
<div class="line">    </div>
<div class="line">    If df is not provided, read table data from raw.</div>
<div class="line">    </div>
<div class="line">    Performs a &#39;merge into&#39;/&#39;upsert&#39; of a dataframe/table-view inside the Delta Table.</div>
<div class="line">    Meaning rows are overwritten if it finds one with the same designated unqique fields, or else it is inserted.</div>
<div class="line">    The batch of updates must not contain more than one row with the same chosen unique key.</div>
<div class="line">    </div>
<div class="line">    Handles the creation of the SQL condition update part. Needs an unique key, can be a combination of 2 or more fields.</div>
<div class="line">    Eg. &quot;ON delta_messages.message_id = updates.message_id AND delta_messages.id = updates.id&quot;</div>
<div class="line">    </div>
<div class="line">    Parameters</div>
<div class="line">    ----------</div>
<div class="line">    config: Config</div>
<div class="line">      Config instance</div>
<div class="line">    </div>
<div class="line">    table: str</div>
<div class="line">      Name of the table / folder.</div>
<div class="line">    </div>
<div class="line">    df: pyspark.sql.DataFrame, optional</div>
<div class="line">      Dataframe containing the data to save in the curated delta table.</div>
<div class="line">    </div>
<div class="line">    transformation: (pyspark.sql.DataFrame) -&gt; pyspark.sql.DataFrame, optional</div>
<div class="line">      A function taking a df and returning a df.</div>
<div class="line">    </div>
<div class="line">    unique_key: list or str, optional</div>
<div class="line">      Columns with unique values or list of columns to use as a combined unique key.</div>
<div class="line">    </div>
<div class="line">    incremental: bool, optional</div>
<div class="line">      To perform incremental load based on the raw-zone&#39;s control table content.</div>
<div class="line">&quot;&quot;&quot;</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
