<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ETL Library: ETL.raw_control Namespace Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ETL Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespace_e_t_l.html">ETL</a></li><li class="navelem"><a class="el" href="namespace_e_t_l_1_1raw__control.html">raw_control</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">ETL.raw_control Namespace Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ab64fbc8de8a732d124cb15ace3a6f192"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespace_e_t_l_1_1raw__control.html#ab64fbc8de8a732d124cb15ace3a6f192">select</a> (config, table_or_string)</td></tr>
<tr class="separator:ab64fbc8de8a732d124cb15ace3a6f192"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6d4aed121c478e2ff4ec9e80e1b915ff"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespace_e_t_l_1_1raw__control.html#a6d4aed121c478e2ff4ec9e80e1b915ff">insert</a> (config, paths, table=None)</td></tr>
<tr class="separator:a6d4aed121c478e2ff4ec9e80e1b915ff"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad39e6d6044dd73899c9bbe334d76362f"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespace_e_t_l_1_1raw__control.html#ad39e6d6044dd73899c9bbe334d76362f">delete</a> (config, table_or_string_pattern)</td></tr>
<tr class="separator:ad39e6d6044dd73899c9bbe334d76362f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaf3c1deecf26ade9e2ea90b62d66bba3"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespace_e_t_l_1_1raw__control.html#aaf3c1deecf26ade9e2ea90b62d66bba3">path_is_valid</a> (path, raise_when_invalid=False)</td></tr>
<tr class="separator:aaf3c1deecf26ade9e2ea90b62d66bba3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaf93032b8eaa4a33b50b29f9d98b3670"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespace_e_t_l_1_1raw__control.html#aaf93032b8eaa4a33b50b29f9d98b3670">create_if_not_exists</a> (config, name=None)</td></tr>
<tr class="separator:aaf93032b8eaa4a33b50b29f9d98b3670"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af869949247d74f2fdc36531a9f62235b"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespace_e_t_l_1_1raw__control.html#af869949247d74f2fdc36531a9f62235b">migrate_legacy_control_table</a> (config)</td></tr>
<tr class="separator:af869949247d74f2fdc36531a9f62235b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a68c01ed82bea7ebc7cea7c18c06e96ac"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespace_e_t_l_1_1raw__control.html#a68c01ed82bea7ebc7cea7c18c06e96ac">build_regex_part</a> (pattern)</td></tr>
<tr class="separator:a68c01ed82bea7ebc7cea7c18c06e96ac"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1ef8845c4b82027ce26849fa781c07f8"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespace_e_t_l_1_1raw__control.html#a1ef8845c4b82027ce26849fa781c07f8">path_to_short_path</a> (path)</td></tr>
<tr class="separator:a1ef8845c4b82027ce26849fa781c07f8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><pre class="fragment">This module provides utility functions to select, insert and delete records of past incremental loads.

Table schema:
(table_name STRING, last_version INT)

Example rows:
inc-2020_01_10_22_35_33/Messages
inc-2020_01_06_16_20_14/Messages
inc-2019_10_30_13_33_24/Messages
inc-2019_10_30_13_33_24/Groups
inc-2020_01_10_22_35_33/Groups
inc-2020_01_06_16_20_14/Topics
inc-2019_12_13_17_40_35/Topics
inc-2020_01_06_16_20_14/Groups
inc-2020_01_13_13_32_08/Groups
inc-2020_01_13_13_32_08/Users

Typical incremental flow:
1. Read content of the control table
2. Get the paths of raw-zone ingestion folders
3. Filter folder paths for table that were not in the control table
4. Get the paths of all files in the remaining folders
5. Read JSON data with spark in one go by passing it the list of file paths
6. If data ingestion is successful, insert folder paths in the control table

It is possible to operate on strings instead of registred table names to look for ingestion path patterns.
Eg. To delete from control table values with table name 'things' but in folder 'inc-2020' only -&gt;
  ETL.raw_control(config, table_or_string='inc-2020/things')
</pre> </div><h2 class="groupheader">Function Documentation</h2>
<a id="a68c01ed82bea7ebc7cea7c18c06e96ac"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a68c01ed82bea7ebc7cea7c18c06e96ac">&#9670;&nbsp;</a></span>build_regex_part()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def ETL.raw_control.build_regex_part </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>pattern</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Build SQL "WHERE path RLIKE -&gt; regex_part &lt;-" to match rows containing tables.

Parameters
----------
pattern: str
  Table to search or string like a specific folder with a table eg. "inc-2020-01-08/table"

Returns
-------
str
</pre> 
</div>
</div>
<a id="aaf93032b8eaa4a33b50b29f9d98b3670"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaf93032b8eaa4a33b50b29f9d98b3670">&#9670;&nbsp;</a></span>create_if_not_exists()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def ETL.raw_control.create_if_not_exists </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>name</em> = <code>None</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Create control table if not exists.

Save raw zone short paths, eg. "inc-2019-06-13/MessagesLikes"

Parameters
----------
config: ETL.Config
  Config instance
name: str, optional
  If specified, name to use.
</pre> 
</div>
</div>
<a id="ad39e6d6044dd73899c9bbe334d76362f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad39e6d6044dd73899c9bbe334d76362f">&#9670;&nbsp;</a></span>delete()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def ETL.raw_control.delete </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>table_or_string_pattern</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Delete all control table rows containing table name or string pattern.

Is case sensitive.

Parameters
----------
config: ETL.Config
  Config instance

table_or_string_pattern: str
</pre> 
</div>
</div>
<a id="a6d4aed121c478e2ff4ec9e80e1b915ff"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6d4aed121c478e2ff4ec9e80e1b915ff">&#9670;&nbsp;</a></span>insert()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def ETL.raw_control.insert </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>paths</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>table</em> = <code>None</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Insert paths in the raw-zone control table.

Valid path example: 'inc-2019_07_18/Topics'

Parameters
----------
config: ETL.Config
  Config instance

paths: list
  Valid DBFS paths to insert in the control table.

table: str, optional
  Only for logging purposes.
</pre> 
</div>
</div>
<a id="af869949247d74f2fdc36531a9f62235b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af869949247d74f2fdc36531a9f62235b">&#9670;&nbsp;</a></span>migrate_legacy_control_table()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def ETL.raw_control.migrate_legacy_control_table </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>config</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Transfer data from the old control table if exists to the new one.

The old table used to have only the "ingestion" table in it
(eg. ".../inc-2019-06-13") but the new table is more granular.
So when migrating, we simply add an entry for every table names
eg. "inc-2019-06-13/MessagesLikes", "inc-2019-06-13/Users"... etc

Some transformations are needed as the new control table values format
allow for a more granular control:

  old format:
      "inc-2019-06-13"

  new format:
      "inc-2019-06-13/MessagesLikes"
      "inc-2019-06-13/Messages"
      "inc-2019-06-13/Users"

Parameters
----------
config: ETL.Config
  Config instance
</pre> 
</div>
</div>
<a id="aaf3c1deecf26ade9e2ea90b62d66bba3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaf3c1deecf26ade9e2ea90b62d66bba3">&#9670;&nbsp;</a></span>path_is_valid()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def ETL.raw_control.path_is_valid </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>raise_when_invalid</em> = <code>False</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a1ef8845c4b82027ce26849fa781c07f8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1ef8845c4b82027ce26849fa781c07f8">&#9670;&nbsp;</a></span>path_to_short_path()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def ETL.raw_control.path_to_short_path </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>path</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Convert any valid dbfs path to keep only the last part for the control table.

'/dbfs/mnt/adls/raw_yammer/yammer/inc-2019_08_40/Messages'
'/dbfs/mnt/adls/raw_yammer/yammer/inc-2019_08_40/Messages/file.json'
to
'inc-2019_08_40/Messages'
'inc-2019_08_40/Messages'

Parameters
----------
path

Returns
-------
str
</pre> 
</div>
</div>
<a id="ab64fbc8de8a732d124cb15ace3a6f192"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab64fbc8de8a732d124cb15ace3a6f192">&#9670;&nbsp;</a></span>select()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def ETL.raw_control.select </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>table_or_string</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Get all control table values matching the table name or string pattern.

Parameters
----------
config: ETL.Config
table_or_string

Returns
-------
list
</pre> 
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
